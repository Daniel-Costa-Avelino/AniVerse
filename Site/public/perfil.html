<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil</title>
    <link rel="stylesheet" href="./style/reset.css">
    <link rel="stylesheet" href="./style/global.css">
    <link rel="stylesheet" href="style/perfil.css">
</head>

<body>

    <!-- Cabeçalho -->
    <header class="cabecalho">
        <div class="div_logo">
            <img src="./assets/logo.png" alt="Logo do site">
        </div>
        <div class="div_links">
            <a href="index.html" class="link">Home</a>
            <a href="recomendacoes.html" class="link">Recomendações</a>
            <a href="historia.html" class="link">História do anime</a>
            <a href="desenvolvedor.html" class="link">Desenvolvedor</a>
        </div>
        <div class="div_login">
            <button class="btn_login" onclick="window.location.href = 'login.html'">Login</button>
        </div>
    </header>
    <!-- Fim do cabeçalho -->

    <section class="sessao_perfil">
        <div class="div_infos">
            <div class="div_avatar">
                <img src="./assets/avatar.png" alt="Avatar do usuário">
            </div>
            <div class="div_infos_pessoal">
                <p><span class="span_p_infos">Username: </span>Naruto123</p>
                <p><span class="span_p_infos">Idade: </span>18</p>
                <p><span class="span_p_infos">Gênero: </span>Masculino</p>
            </div>
            <div class="div_infos_anime_lista">
                <p><span class="span_p_infos">Anime preferido: </span>Naruto</p>
                <p><span class="span_p_infos">Último anime adicionado: </span>One Piece</p>
                <p><span class="span_p_infos">Animes adicionados: </span>23</p>
            </div>
        </div>
        <div class="div_links_dashboard_editar">
            <button class="btn_acessarDash" onclick="window.location.href = './dashboard.html'">Acessar
                Dashboard</button>
            <button class="btn_acessarDash" onclick="window.location.href = './recomendacoes.html'">Acessar
                recomendações</button>
            <button class="btn_editar">
                <img src="./assets/iconeEditar.png" alt="Ícone de Editar">
                Editar
            </button>
        </div>
    </section>

    <section class="sessao_ordenar">
        <h1 class="titulo_ordenar">Ordenar por:</h1>
        <div class="div_selects_ordenar">
            <select name="select_genero" id="select_ordenarGenero">
                <option value="#">Selecione um gênero</option>
                <option value="terror">Terror</option>
                <option value="comedia">Comédia</option>
                <option value="aventura">Aventura</option>
                <option value="fantasia">Fantasia</option>
                <option value="romance">Romance</option>
            </select>

            <select name="select_ordem" id="select_ordemAlfabetica">
                <option value="#">Ordem alfabética</option>
                <option value="crescente">Crescente</option>
                <option value="decrescente">Decrescente</option>
            </select>

            <select name="select_data" id="select_datalancamento">
                <option value="#">Data de lançamento</option>
                <option value="atual">Mais atual</option>
                <option value="antigo">Mais antigo</option>
            </select>

            <button class="btn_filtrar">
                <img src="./assets/iconeFiltro.png" alt="Icone de filtro">
                Filtrar
            </button>
        </div>
    </section>

    <section class="sessao_animesAssistidos">
        <div class="div_titulo_lista">
            <h1>
                Lista dos seus animes assistidos
            </h1>
        </div>

        <div class="div_btn_adicionar_anime">
            <button onclick="mostrarModal()">
                <img src="./assets/iconeAdicionar.png" alt="Ícone de adicionar">
                <p>Adicionar novo anime</p>
            </button>
        </div>

        <div class="div_lista_animes" id="div_lista_de_animes">
            <!-- <div class="card_anime_assistido">
                <div class="div_img_anime">
                    <img src="./assets/imgCard.png" alt="Imagem do anime">
                </div>
                <div class="div_infos_anime">
                    <h1 class="titulo_anime">Demon slayer</h1>
                    <p class="p_descricao"><span class="span_destaque">Descrição: </span>Tanjiro Kamado, um jovem que se
                        torna um caçador de demônios após sua família ser
                        massacrada e sua irmã Nezuko ser transformada em um demônio. Ele embarca em uma jornada para
                        encontrar uma cura para Nezuko e vingar sua família, lutando contra criaturas demoníacas e
                        outras
                        ameaças. A série também explora temas como família, amizade, redenção e o poder de superar a
                        adversidade.</p>
                    <p class="p_temporadas"><span class="span_destaque">Temporadas:</span> 4</p>
                    <p class="p_episodios"><span class="span_destaque">Episódios:</span> 63</p>
                    <p class="p_nota_usuario"><span class="span_destaque">Nota do usuário:</span> 4.5</p>
                    <p class="p_genero_anime"><span class="span_destaque">Gênero:</span> Luta</p>
                    <p class="p_onde_assistir"><span class="span_destaque">Onde assistir:</span> Crunchyroll</p>
                    <p class="p_periodo"><span class="span_destaque">Período de exibição:</span></p>
                    <p class="p_data_lancamento"><span class="span_destaque">Data de lançamento:</span> 06 de Abril de
                        2019
                    </p>
                    <p class="p_data_ultimo_episodio"><span class="span_destaque">Último episódio lançado:</span> 30 de
                        Junho de 2024</p>
                </div>
            </div> -->
        </div>
    </section>

    <!-- Rodapé -->
    <footer>
        <div class="div_rodape_logo">
            <img src="./assets/logoGrande.png" alt="Logo do site">
        </div>
        <div class="div_rodape_links">
            <a href="index.html" class="link_rodape">Home</a>
            <a href="recomendacoes.html" class="link_rodape">Recomendações</a>
            <a href="desenvolvedor.html" class="link_rodape">Desenvolvedor</a>
            <a href="historia.html" class="link_rodape">História</a>
            <a href="login.html" class="link_rodape">Login</a>
            <a href="cadastro.html" class="link_rodape">Cadastro</a>
        </div>
        <div class="div_rodape_redesSociais">
            <div class="div_siga">
                <p>Siga-nos nas redes sociais</p>
            </div>
            <div class="div_rodape_linksRedesSociais">
                <img src="./assets/imgFacebook.png" alt="ícone facebook">
                <img src="./assets/Twitter.png" alt="Ícone twitter">
            </div>
            <div class="div_rodape_linksRedesSociais">
                <img src="./assets/imgInstagram.png" alt="Ícone instagram">
                <img src="./assets/Discord.png" alt="Ícone discord">
            </div>
        </div>
    </footer>
    <!-- Fim rodapé -->

    <section id="section_modal">
        <div class="div_form_add_anime">
            <div class="div_header_modal">
                <h1 class="titulo_form">Adicionar o anime assistido</h1>
                <img src="./assets/fecharModal.png" alt="Icone fechar modal" id="imgFecharModal"
                    onclick="fecharModal()">
            </div>

            <div class="div_campo">
                <p class="p_campo">Nome:</p>
                <input type="text" id="input_nomeAnime" placeholder="Digite o nome do anime">
            </div>
            <div class="div_campo">
                <p class="p_campo">Descrição:</p>
                <input type="text" id="input_descricao" placeholder="Digite a descrição do anime">
            </div>
            <div class="div_campo">
                <p class="p_campo">Imagem:</p>
                <input type="text" id="input_imagem" placeholder="Digite o endereço da imagem do Anime">
            </div>
            <div class="div_campo_temporadas_episodios">
                <div class="div_campo">
                    <p class="p_campo">Temporadas:</p>
                    <input type="text" id="input_temporadasAnime" placeholder="Digite a quantidade de temporadas">
                </div>

                <div class="div_campo">
                    <p class="p_campo">Episódios:</p>
                    <input type="text" id="input_episodiosAnime" placeholder="Digite a quantidade de episódios">
                </div>
            </div>

            <div class="div_campo">
                <p class="p_campo">Onde assistir:</p>
                <input type="text" id="input_ondeAssistirAnime" placeholder="Digite onde pode ver esse anime">
            </div>
            <div class="div_datas">
                <div class="div_campo">
                    <p class="p_campo">Data de lançamento:</p>
                    <input type="date" id="input_dtLancamentoAnime" placeholder="Data de lançamento do anime">
                </div>
                <div class="div_campo">
                    <p class="p_campo">Data do último episódio lançado:</p>
                    <input type="date" id="input_dtLancamentoAnimeUltimoEpisodio"
                        placeholder="Digite a data do último do anime">
                </div>
            </div>

            <div class="div_campo">
                <p class="p_campo">Gênero:</p>
                <input type="text" id="input_generoAnime" placeholder="Digite o gênero do anime">
            </div>
            <div class="div_campo">
                <p class="p_campo">Classificação indicativa:</p>
                <input type="text" id="input_classificacaoIndicativaAnime"
                    placeholder="Digite a classificação indicativa do anime">
            </div>
            <div class="div_campo">
                <p class="p_campo">Sua nota:</p>
                <input type="text" id="input_notaAnime" placeholder="Digite a sua nota para o anime">
            </div>
            <div class="div_campo">
                <button class="btn_adicionar" onclick="adicionarAnime()">Adicionar</button>
            </div>
        </div>
    </section>


</body>

</html>

<script>

    window.onload = exibirAnime();

    function mostrarModal() {
        section_modal.style.display = "flex";
    }

    function fecharModal() {
        section_modal.style.display = "none";
    }

    function adicionarAnime() {
        // aguardar();

        //Recupere o valor da nova input pelo nome do id
        // Agora vá para o método fetch logo abaixo

        var nomeAnime = input_nomeAnime.value;
        var descricao = input_descricao.value;
        var imagem = input_imagem.value;
        var temporadasAnime = Number(input_temporadasAnime.value);
        var episodiosAnime = Number(input_episodiosAnime.value);
        var ondeAssistirAnime = input_ondeAssistirAnime.value;
        var dtLancamentoAnime = input_dtLancamentoAnime.value;
        var dtLancamentoAnimeUltimoEpisodio = input_dtLancamentoAnimeUltimoEpisodio.value;
        var generoAnime = input_generoAnime.value;
        var classificacaoIndicativaAnime = Number(input_classificacaoIndicativaAnime.value);
        var notaAnime = Number(input_notaAnime.value);
        var idUsuario = sessionStorage.getItem("ID_USUARIO");

        // Verificando se há algum campo em branco
        if (
            nomeAnime == '' ||
            descricao == '' ||
            imagem == '' ||
            temporadasAnime == '' ||
            episodiosAnime == '' ||
            ondeAssistirAnime == '' ||
            dtLancamentoAnime == '' ||
            dtLancamentoAnime == '' ||
            generoAnime == '' ||
            classificacaoIndicativaAnime == '' ||
            notaAnime == '' ||
            idUsuario == ''
        ) {
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "(Mensagem de erro para todos os campos em branco)";

            //finalizarAguardar();
            return false;
        } else {
            //setInterval(sumirMensagem, 5000);
        }

        // Enviando o valor da nova input
        fetch("/perfil/adicionarAnime", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/usuario.js
                nomeAnimeServer: nomeAnime,
                descricaoServer: descricao,
                imagemServer: imagem,
                temporadasAnimeServer: temporadasAnime,
                episodiosAnimeServer: episodiosAnime,
                ondeAssistirAnimeServer: ondeAssistirAnime,
                dtLancamentoAnimeServer: dtLancamentoAnime,
                dtLancamentoAnimeUltimoEpisodioServer: dtLancamentoAnimeUltimoEpisodio,
                generoAnimeServer: generoAnime,
                classificacaoIndicativaAnimeServer: classificacaoIndicativaAnime,
                notaAnimeServer: notaAnime,
                idUsuarioServer: idUsuario
            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    //cardErro.style.display = "block";

                    // mensagem_erro.innerHTML =
                    //     "Anime adicionado com sucesso!";

                    // setTimeout(() => {
                    //     window.location = "login.html";
                    // }, "2000");

                    //finalizarAguardar();
                } else {
                    throw "Houve um erro ao tentar realizar o cadastro!";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
                //finalizarAguardar();
            });

        return false;
    }

    // function sumirMensagem() {
    //     cardErro.style.display = "none";
    // }


    function exibirAnime() {
        //aguardar();

        var idUsuario = sessionStorage.getItem("ID_USUARIO");

        if (idUsuario == undefined) {
            //cardErro.style.display = "block"
            //mensagem_erro.innerHTML = "(Mensagem de erro para todos os campos em branco)";
            //finalizarAguardar();
            alert("usuario undefined")
            return false;
        }
        else {
            //setInterval(sumirMensagem, 5000)
        }

        fetch("/exibirAnime/exibirAnimesAssistidos", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idUsuarioServer: idUsuario
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO entrar()!")

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));

                    for (var i = 0; i < json.length; i++) {

                        var dataLancamentoAnime = new Date(json[i].dtLancamento);
                        var dataLancamentoAnimeFormatada = dataLancamentoAnime.toLocaleDateString('pt-BR');

                        var dataUltimoEpLancado = new Date(json[i].dtUltimoEpLancado);
                        var dataUltimoEpLancadoFormatada = dataUltimoEpLancado.toLocaleDateString('pt-BR');

                        div_lista_de_animes.innerHTML += `
                        <div class="card_anime_assistido">
                <div class="div_img_anime">
                    <img src=${json[i].imagemAnime} alt="Imagem do anime">
                </div>
                <div class="div_infos_anime">
                    <h1 class="titulo_anime">${json[i].nome}</h1>
                    <p class="p_descricao"><span class="span_destaque">Descrição: </span>
                        ${json[i].descricao}</p>
                    <p class="p_temporadas"><span class="span_destaque">Temporadas:</span> 
                        ${json[i].temporadas}</p>
                    <p class="p_episodios"><span class="span_destaque">Episódios:</span> 
                        ${json[i].episodios}</p>
                    <p class="p_nota_usuario"><span class="span_destaque">Nota do usuário:</span>
                        ${json[i].notaUser}</p>
                    <p class="p_genero_anime"><span class="span_destaque">Gênero:</span> 
                        ${json[i].genero}</p>
                    <p class="p_onde_assistir"><span class="span_destaque">Onde assistir:</span>
                         ${json[i].onde_assistir}</p>
                    <p class="p_periodo"><span class="span_destaque">Período de exibição:</span></p>
                    <p class="p_data_lancamento"><span class="span_destaque">Data de lançamento:</span>
                        ${dataLancamentoAnimeFormatada}
                    </p>
                    <p class="p_data_ultimo_episodio"><span class="span_destaque">Último episódio lançado:</span> 
                        ${dataUltimoEpLancadoFormatada}</p>
                </div>
            </div>
                        `;
                    }
                });
            } else {

                console.log("Houve um erro ao tentar exibir os animes!");

                resposta.text().then(texto => {
                    console.error(texto);
                    //finalizarAguardar(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }
</script>